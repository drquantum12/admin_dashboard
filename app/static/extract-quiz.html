<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Extract Quiz â€“ VijayeBhav Admin</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600&display=swap" rel="stylesheet" />
  <style>
    body {
      font-family: 'Inter', sans-serif;
      margin: 0;
      padding: 0;
      background: #f1f5f9;
      color: #1e293b;
    }
    .container {
      display: flex;
      height: 100vh;
      width: 100vw;
    }
    .left-section {
      width: 33%;
      background: #fff;
      border-right: 1px solid #e5e7eb;
      display: flex;
      flex-direction: column;
      justify-content: flex-start;
      align-items: stretch;
      padding: 32px 24px;
      box-sizing: border-box;
    }
    .upload-section {
      margin-bottom: 32px;
      padding-bottom: 24px;
      border-bottom: 1px solid #e5e7eb;
    }
    .upload-section h2 {
      font-size: 1.2rem;
      color: #4f46e5;
      margin-bottom: 12px;
    }
    .upload-box {
      background: #f1f5f9;
      border: 2px dashed #4f46e5;
      border-radius: 8px;
      padding: 24px;
      text-align: center;
      cursor: pointer;
      transition: border-color 0.2s;
    }
    .upload-box:hover {
      border-color: #4338ca;
    }
    .upload-box input[type="file"] {
      display: none;
    }
    .output-section {
      flex: 1;
      margin-top: 24px;
      overflow-y: auto;
    }
    .output-section h2 {
      font-size: 1.1rem;
      color: #4f46e5;
      margin-bottom: 10px;
    }
    .output-content {
      background: #f8fafc;
      border-radius: 8px;
      padding: 16px;
      font-size: 0.98rem;
      color: #334155;
      min-height: 120px;
      max-height: 300px;
      overflow-y: auto;
      border: 1px solid #e5e7eb;
    }
    .right-section {
      width: 67%;
      padding: 40px 32px;
      box-sizing: border-box;
      overflow-y: auto;
      background: #f1f5f9;
      display: flex;
      flex-direction: column;
      align-items: stretch;
    }
    .quiz-list {
      display: flex;
      flex-direction: column;
      gap: 24px;
    }
    .quiz-card {
      background: #fff;
      border-radius: 12px;
      box-shadow: 0 4px 10px rgba(0, 0, 0, 0.04);
      padding: 24px;
      border: 1px solid #e2e8f0;
      transition: box-shadow 0.2s;
    }
    .quiz-card:hover {
      box-shadow: 0 6px 16px rgba(79, 70, 229, 0.08);
    }
    .quiz-question {
      font-weight: 600;
      color: #4f46e5;
      margin-bottom: 10px;
      font-size: 1.1rem;
    }
    .quiz-options {
      margin-bottom: 8px;
      color: #334155;
    }
    .quiz-answer {
      color: #16a34a;
      font-weight: 500;
      font-size: 0.98rem;
    }
    @media screen and (max-width: 900px) {
      .container {
        flex-direction: column;
      }
      .left-section, .right-section {
        width: 100%;
        padding: 20px;
      }
    }
  </style>
</head>
<body>
  <div class="container">
    <div class="left-section">
      <div class="upload-section">
        <h2 style="margin-bottom: 18px;">Upload PDF</h2>
        <label class="upload-box" style="display: flex; flex-direction: column; align-items: center; gap: 12px;">
          <span id="upload-label" style="font-size: 1rem; color: #4f46e5; font-weight: 500;">Click to select a PDF file</span>
          <input type="file" id="pdf-upload" accept="application/pdf" />
        </label>
        <button id="submit-btn" type="button" style="margin-top: 16px; background-color: #4f46e5; color: white; border: none; border-radius: 6px; padding: 10px 24px; font-weight: 600; font-size: 1rem; cursor: pointer; transition: background 0.2s;">Submit PDF</button>
      </div>
      <button id="upload-quiz-btn" type="button" style="margin-bottom: 18px; background-color: #16a34a; color: white; border: none; border-radius: 6px; padding: 10px 24px; font-weight: 600; font-size: 1rem; cursor: pointer; transition: background 0.2s;">Upload</button>
      <div class="output-section" style="flex: 2; min-height: 300px;">
        <h2>Real-time Output</h2>
        <div class="output-content" id="output-content" style="min-height: 220px; max-height: 500px;">
          Waiting for PDF upload...
        </div>
      </div>
    </div>
    <div class="right-section">
      <div style="display: flex; gap: 18px; margin-bottom: 18px;">
        <select id="board-input" style="padding: 10px; border-radius: 6px; border: 1px solid #e2e8f0; font-size: 1rem; width: 160px;">
          <option value="">Select Board</option>
          <option value="ICSE">ICSE</option>
          <option value="CBSE">CBSE</option>
        </select>
        <select id="grade-input" style="padding: 10px; border-radius: 6px; border: 1px solid #e2e8f0; font-size: 1rem; width: 160px;">
          <option value="">Select Grade</option>
          <option value="GRADE_1">GRADE 1</option>
          <option value="GRADE_2">GRADE 2</option>
          <option value="GRADE_3">GRADE 3</option>
          <option value="GRADE_4">GRADE 4</option>
          <option value="GRADE_5">GRADE 5</option>
          <option value="GRADE_6">GRADE 6</option>
          <option value="GRADE_7">GRADE 7</option>
          <option value="GRADE_8">GRADE 8</option>
          <option value="GRADE_9">GRADE 9</option>
          <option value="GRADE_10">GRADE 10</option>
          <option value="GRADE_11">GRADE 11</option>
          <option value="GRADE_12">GRADE 12</option>
          <option value="ABOVE_GRADE_12">Above GRADE 12</option>
        </select>
        <select id="subject-input" style="padding: 10px; border-radius: 6px; border: 1px solid #e2e8f0; font-size: 1rem; width: 160px;">
          <option value="">Select Subject</option>
          <option value="Science">Science</option>
          <option value="Mathematics">Mathematics</option>
          <option value="Hindi">Hindi</option>
          <option value="English">English</option>
          <option value="Social Studies">Social Studies</option>
          <option value="Physics">Physics</option>
          <option value="Chemistry">Chemistry</option>
          <option value="Biology">Biology</option>
          <option value="Computer Science">Computer Science</option>
        </select>
        <select id="year-input" style="padding: 10px; border-radius: 6px; border: 1px solid #e2e8f0; font-size: 1rem; width: 160px;">
          <option value="">Select Year</option>
        </select>
        <input type="text" id="exam-name" placeholder="Exam Name" style="padding: 10px; border-radius: 6px; border: 1px solid #e2e8f0; font-size: 1rem; width: 160px;" />
      </div>
      <h2 style="color:#4f46e5; margin-bottom:24px;">Extracted Quiz Questions</h2>
      <button id="add-quiz-btn" class="add-quiz-btn" style="margin-bottom: 16px; background: #4f46e5; color: #fff; border: none; padding: 10px 18px; border-radius: 8px; font-weight: 600; cursor: pointer;">
        + Add Quiz Manually
      </button>
      <div class="quiz-list" id="quiz-list">
        <!-- Quiz cards will be rendered here -->
      </div>
    </div>
  </div>
  <!-- Modal for adding quiz manually -->
  <div id="add-quiz-modal" class="modal" style="display:none; position:fixed; top:0; left:0; width:100vw; height:100vh; background:rgba(30,41,59,0.3); z-index:1000; justify-content:center; align-items:center;">
    <div style="background:#fff; border-radius:12px; padding:32px; min-width:320px; max-width:400px; box-shadow:0 8px 32px rgba(79,70,229,0.12); position:relative;">
      <h2 style="color:#4f46e5; margin-bottom:18px;">Add Quiz Question</h2>
      <label style="font-weight:500;">Question:</label>
      <textarea id="manual-question" style="width:100%; margin-bottom:12px; border-radius:6px; border:1px solid #e5e7eb; padding:8px;"></textarea>
      <label style="font-weight:500;">Options (comma separated):</label>
      <input id="manual-options" type="text" style="width:100%; margin-bottom:12px; border-radius:6px; border:1px solid #e5e7eb; padding:8px;" />
      <label style="font-weight:500;">Correct Answer (comma separated):</label>
      <input id="manual-correct" type="text" style="width:100%; margin-bottom:12px; border-radius:6px; border:1px solid #e5e7eb; padding:8px;" />
      <label style="font-weight:500;">Attach Image:</label>
      <input id="manual-image" type="file" accept="image/*" style="margin-bottom:12px;" />
      <div id="manual-image-preview" style="margin-bottom:12px;"></div>
      <div style="display:flex; justify-content:flex-end; gap:12px;">
        <button id="cancel-add-quiz" style="background:#64748b; color:#fff; border:none; padding:8px 16px; border-radius:6px; font-weight:500; cursor:pointer;">Cancel</button>
        <button id="submit-add-quiz" style="background:#4f46e5; color:#fff; border:none; padding:8px 16px; border-radius:6px; font-weight:600; cursor:pointer;">Add</button>
      </div>
    </div>
  </div>
  <script>
    const pdfInput = document.getElementById('pdf-upload');
    const outputContent = document.getElementById('output-content');
    const quizList = document.getElementById('quiz-list');
    const uploadLabel = document.getElementById('upload-label');


  let selectedFile = null;
  let lastQuizArray = [];
    pdfInput.addEventListener('change', (event) => {
      selectedFile = event.target.files[0];
      if (!selectedFile) return;
      uploadLabel.textContent = selectedFile.name;
      outputContent.textContent = 'Ready to submit PDF.';
      quizList.innerHTML = '';
    });

    document.getElementById('submit-btn').addEventListener('click', async () => {
      if (!selectedFile) {
        outputContent.textContent = 'Please select a PDF file first.';
        return;
      }
      outputContent.textContent = 'Uploading PDF and starting extraction...';
      quizList.innerHTML = '';
      const formData = new FormData();
      formData.append('pdf', selectedFile);
        try {
          outputContent.textContent = 'Processing PDF...';
          const extractResponse = await fetch('/preprocess/quiz/extract-quiz', {
            method: 'POST',
            body: formData
          });
          if (!extractResponse.ok) {
            outputContent.textContent = 'Error processing PDF.';
            return;
          }
          const reader = extractResponse.body.getReader();
          let received = '';
          let quizzes = [];
          let doneReading = false;
          while (!doneReading) {
            const { done, value } = await reader.read();
            if (done) {
              doneReading = true;
              break;
            }
            const chunk = new TextDecoder().decode(value);
            received += chunk;
            // Try to parse chunk as JSON
            let parsed = null;
            try {
              parsed = JSON.parse(chunk.trim());
            } catch (e) {
              // Not valid JSON, show as real-time output
              outputContent.textContent += chunk;
            }
            if (parsed && Array.isArray(parsed)) {
              quizzes = parsed;
              renderQuizzes(quizzes);
              outputContent.textContent = 'Extraction complete.';
            }
          }
          // Final parse if needed
          if (!quizzes.length) {
            try {
              quizzes = JSON.parse(received.trim().split('\n').pop());
              renderQuizzes(quizzes);
              outputContent.textContent = 'Extraction complete.';
            } catch (e) {
              outputContent.textContent = 'Extraction finished, but could not parse quiz data.';
            }
          }
        } catch (err) {
          outputContent.textContent = 'Error: ' + err.message;
        }
      }
    );

    function renderQuizzes(quizzes) {
  quizList.innerHTML = '';
  lastQuizArray = quizzes;
  if (!Array.isArray(quizzes) || quizzes.length === 0) {
    quizList.innerHTML = '<div style="color:#64748b;">No quiz questions found.</div>';
    return;
  }
  quizzes.forEach((q, idx) => {
    const card = document.createElement('div');
    card.className = 'quiz-card';

    // Editable question input
    const questionInput = document.createElement('textarea');
    questionInput.value = q.question || '';
    questionInput.style.width = '100%';
    questionInput.style.marginBottom = '10px';
    questionInput.style.fontWeight = '600';
    questionInput.style.color = '#4f46e5';
    questionInput.style.fontSize = '1.05rem';
    questionInput.onchange = () => {
      lastQuizArray[idx].question = questionInput.value.trim();
    };

    // Editable options input
    const optionsInput = document.createElement('input');
    optionsInput.type = 'text';
    optionsInput.value = q.options ? q.options.join(', ') : '';
    optionsInput.placeholder = 'Edit options (comma separated)';
    optionsInput.style.marginBottom = '8px';
    optionsInput.style.width = '100%';
    optionsInput.onchange = () => {
      lastQuizArray[idx].options = optionsInput.value.split(',').map(s => s.trim()).filter(Boolean);
    };

    // Correct answer input
    const correctAnswerInput = document.createElement('input');
    correctAnswerInput.type = 'text';
    correctAnswerInput.value = q.correct_answer ? q.correct_answer.join(', ') : '';
    correctAnswerInput.placeholder = 'Edit correct answer (comma separated)';
    correctAnswerInput.style.marginBottom = '8px';
    correctAnswerInput.style.width = '100%';
    correctAnswerInput.onchange = () => {
      lastQuizArray[idx].correct_answer = correctAnswerInput.value.split(',').map(s => s.trim()).filter(Boolean);
    };

    // Image upload
    const imageUploadLabel = document.createElement('label');
    imageUploadLabel.textContent = 'Upload Image:';
    imageUploadLabel.style.marginRight = '8px';
    const imageInput = document.createElement('input');
    imageInput.type = 'file';
    imageInput.accept = 'image/*';
    imageInput.style.marginBottom = '8px';
    imageInput.onchange = async (e) => {
      const file = e.target.files[0];
      if (!file) return;
      const formData = new FormData();
      formData.append('image', file);
      try {
        const res = await fetch('/preprocess/quiz/upload-image', {
          method: 'POST',
          body: formData
        });
        if (!res.ok) {
          alert('Image upload failed');
          return;
        }
        const data = await res.json();
        if (data.url) {
          lastQuizArray[idx].image_url = data.url;
          imgPreview.src = data.url;
          imgPreview.style.display = 'block';
        }
      } catch (err) {
        alert('Error uploading image: ' + err.message);
      }
    };
    // Image preview
    const imgPreview = document.createElement('img');
    imgPreview.style.maxWidth = '100%';
    imgPreview.style.marginTop = '8px';
    imgPreview.style.display = q.image_url ? 'block' : 'none';
    if (q.image_url) imgPreview.src = q.image_url;

    // Card HTML for correct answer label
    const answerDiv = document.createElement('div');
    answerDiv.className = 'quiz-answer';
    answerDiv.innerHTML = `<strong>Correct Answer:</strong>`;

    // Append all elements to card
    card.appendChild(questionInput);
    card.appendChild(optionsInput);
    card.appendChild(answerDiv);
    card.appendChild(correctAnswerInput);
    card.appendChild(imageUploadLabel);
    card.appendChild(imageInput);
    card.appendChild(imgPreview);

    quizList.appendChild(card);
  });
}

// Populate year dropdown from 2000 to current year
const yearSelect = document.getElementById('year-input');
const currentYear = new Date().getFullYear();
for (let y = 2000; y <= currentYear; y++) {
  const opt = document.createElement('option');
  opt.value = y;
  opt.textContent = y;
  yearSelect.appendChild(opt);
}

document.getElementById('upload-quiz-btn').addEventListener('click', async () => {
  if (!Array.isArray(lastQuizArray) || lastQuizArray.length === 0) {
    outputContent.textContent = 'No quiz questions to upload.';
    return;
  }
  const board = document.getElementById('board-input').value;
  const grade = document.getElementById('grade-input').value;
  const subject = document.getElementById('subject-input').value;
  const year = document.getElementById('year-input').value;
  const examName = document.getElementById('exam-name').value.trim();
  if (!board || !grade || !subject || !examName) {
    outputContent.textContent = 'Please select Board, Grade, Subject, and Exam Name.';
    return;
  }
  // Attach board, grade, subject, year (if selected), examName to each quiz object
  const quizWithMeta = lastQuizArray.map(q => {
    const meta = { ...q, board, grade, subject, examName };
    if (year) meta.year = year;
    return meta;
  });
  outputContent.textContent = 'Uploading quiz questions to database...';
  try {
    const uploadResponse = await fetch('/preprocess/quiz/upload-to-db', {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json'
      },
      body: JSON.stringify(quizWithMeta)
    });
    if (!uploadResponse.ok) {
      outputContent.textContent = 'Error uploading quiz questions.';
      return;
    }
    outputContent.textContent = 'Quiz questions uploaded successfully!';
  } catch (err) {
    outputContent.textContent = 'Error: ' + err.message;
  }
});

// Add Quiz Manually Modal Logic
const addQuizBtn = document.getElementById('add-quiz-btn');
const addQuizModal = document.getElementById('add-quiz-modal');
const cancelAddQuiz = document.getElementById('cancel-add-quiz');
const submitAddQuiz = document.getElementById('submit-add-quiz');
const manualImageInput = document.getElementById('manual-image');
const manualImagePreview = document.getElementById('manual-image-preview');

let manualImageUrl = "";

addQuizBtn.addEventListener('click', () => {
  addQuizModal.style.display = 'flex';
  manualImagePreview.innerHTML = "";
  manualImageUrl = "";
  manualImageInput.value = "";
  document.getElementById('manual-question').value = "";
  document.getElementById('manual-options').value = "";
  document.getElementById('manual-correct').value = "";
});

cancelAddQuiz.addEventListener('click', () => {
  addQuizModal.style.display = 'none';
});

manualImageInput.addEventListener('change', async (e) => {
  const file = e.target.files[0];
  if (!file) return;
  // Upload image to backend
  const formData = new FormData();
  formData.append('image', file);
  manualImagePreview.innerHTML = "Uploading image...";
  try {
    const uploadResponse = await fetch('/preprocess/quiz/upload-image', {
      method: 'POST',
      body: formData
    });
    const result = await uploadResponse.json();
    if (result.success && result.url) {
      manualImageUrl = result.url;
      manualImagePreview.innerHTML = `<img src="${manualImageUrl}" style="max-width:100%; border-radius:8px;" />`;
    } else {
      manualImagePreview.innerHTML = "Image upload failed.";
    }
  } catch (err) {
    manualImagePreview.innerHTML = "Image upload error.";
  }
});

submitAddQuiz.addEventListener('click', () => {
  const question = document.getElementById('manual-question').value.trim();
  const options = document.getElementById('manual-options').value.split(',').map(opt => opt.trim()).filter(opt => opt);
  const correct = document.getElementById('manual-correct').value.split(',').map(ans => ans.trim()).filter(ans => ans);
  if (!question || options.length === 0) {
    alert("Please enter question and at least one option.");
    return;
  }
  // Add to quiz array
  lastQuizArray.push({
    question: question,
    options: options,
    correct_answer: correct,
    image_url: manualImageUrl
  });
  renderQuizzes(lastQuizArray);
  addQuizModal.style.display = 'none';
});
  </script>
</body>
</html>